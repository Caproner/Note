# 第十三章 文件结构

本章主要讨论文件结构的组织和存取。

## 文件存取

文件中存的东西一般被称为记录，一个记录包括键和值两个域。其中记录中的键要求严格升序。

> 举个例子，在关于学生的文件中，键就是学号；而在一般的文本文件中，键可以是行号

文件存取方式有两种：顺序存取和随机存取。

### 顺序文件

顺序文件指其中的记录使用顺序存取的方式。

#### 顺序文件的更新

顺序文件的更新过程会涉及到的文件有四个：

+ 新主文件：更新后的文件
+ 旧主文件：更新前的文件
+ 事务文件：更新的操作，其每条记录的值包括操作（添加、修改、删除）和操作内容
+ 错误报告文件：用于存放更新时产生的错误

其更新的大致操作便是：旧主文件+事务文件→新文件（出错时写错误报告文件）

具体操作如下：

+ 创建新的新主文件，并同时顺序读取事务文件和旧主文件
  + 顺序读取的过程中可以将事务文件和旧主文件（甚至包括新主文件）看作是队列，后面的操作也就当做队列来描述
+ 重复比较队首直至双方队列全空：
  + 当事务文件队首的键小于旧主文件队首的键，或者旧主文件队列已空，此时事务便肯定是一个添加操作，执行该事务文件的记录操作并将新增的内容push入新主文件，并pop事务文件队首
    + 如果这个事务并不是添加操作时表示出错，记录错误报告
  + 当事务文件队首的键等于旧主文件队首的键，此时事务便肯定是一个修改或删除操作，执行该事务文件的记录操作并将新增的内容push入新主文件，并pop事务文件队首和旧主文件的队首
    + 如果这个事务是一个添加操作时表示出错，记录错误报告
  + 当事务文件队首的键大于旧主文件队首的键，或者事务文件队列已空，此时表示当前旧主文件记录保持原样，将旧主文件的队首pop并push入新主文件，并pop旧主文件的队首

### 索引文件

索引文件相当于一个而外的键值表，通过存储顺序文件的键和其对应的地址（预先全读入内存），从而实现目标顺序文件的随机存取。

由于索引文件事先读入内存，故每次查找顺序文件的时候就可以用二分来较快找到目标键对应的记录。

引入索引文件的缺点是增加内存开销。

#### 倒排文件

索引文件同样可以存其他值跟地址的映射表，这种索引文件被称为倒排文件。

### 哈希文件

前面说到，用索引文件实现随机存取的缺点就是增加内存开销来存映射表。为了降低这块开销就有了哈希文件。

哈希文件只需要存取键和地址的哈希方法即可。于是就可以用O(1)的存储来得到随机存取的效果。

其缺点也是有的，既然是哈希了就不可避免的要解决哈希冲突，解决方法会或多或少的增加时间开销（开放寻址）或空间开销（桶哈希），或者都增加（链表哈希）。

## 目录

> 本书对目录这块讲的十分浅，所以笔记里面也就没啥了。。
>
> 话说这本书讲啥都是很浅的好吗orz。。毕竟是导论啊

在大多数操作系统中，目录相当于用一棵树维护了文件的位置。

## 文本文件和二进制文件

其实这两者从存储层面上没有区别，有的也就是译码的区别。

文本文件使用字符编码系统（ASCII，UTF-8等）译码之后显示，而二进制文件直接按字节（或者按字）译为十进制（或十六进制）数字显示。